@using MusicGrabber.Models
@using MusicGrabber.Services
@inject ToolDownloadService ToolDownload

<div class="settings-overlay" @onclick="OnClose">
    <div class="settings-dialog" @onclick:stopPropagation="true">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="btn btn-sm" @onclick="OnClose">✕</button>
        </div>
        <div class="settings-body">
            <div class="form-group">
                <label>Spotify Client ID</label>
                <input class="form-input" @bind="_clientId" @bind:after="AutoSave" placeholder="Paste your Client ID here" />
            </div>
            <div class="form-group">
                <label>Download Folder</label>
                <input class="form-input" @bind="_downloadPath" @bind:after="AutoSave" />
            </div>
            <div class="form-group">
                <label>yt-dlp Path</label>
                <div class="input-with-action">
                    <input class="form-input" @bind="_ytDlpPath" @bind:after="AutoSave" placeholder="yt-dlp (or full path)" />
                    @if (_downloadingYtDlp)
                    {
                        <button class="btn btn-sm" disabled><span class="spinner"></span> Downloading...</button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-primary" @onclick="DownloadYtDlp">
                            @(ToolDownload.YtDlpExists ? "✓ Reinstall" : "⬇ Download")
                        </button>
                    }
                </div>
            </div>
            <div class="form-group">
                <label>ffmpeg Path</label>
                <div class="input-with-action">
                    <input class="form-input" @bind="_ffmpegPath" @bind:after="AutoSave" placeholder="ffmpeg (or full path)" />
                    @if (_downloadingFfmpeg)
                    {
                        <button class="btn btn-sm" disabled><span class="spinner"></span> Downloading...</button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-primary" @onclick="DownloadFfmpeg">
                            @(ToolDownload.FfmpegExists ? "✓ Reinstall" : "⬇ Download")
                        </button>
                    }
                </div>
            </div>
            @if (_toolMessage != null)
            {
                <div class="tool-message @(_toolError ? "error" : "")">@_toolMessage</div>
            }
            <div class="form-group">
                <label>MP3 Player Drive</label>
                <select class="form-select" @bind="_selectedDrive" @bind:after="AutoSave">
                    <option value="">-- Select drive --</option>
                    @foreach (var drive in _drives)
                    {
                        <option value="@drive.Name.TrimEnd('\\')">@drive.Name (@drive.VolumeLabel, @drive.DriveType)</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Device Subfolder</label>
                <input class="form-input" @bind="_subfolder" @bind:after="AutoSave" placeholder="Music" />
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public AppSettings Settings { get; set; } = default!;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    private string _clientId = "";
    private string _downloadPath = "";
    private string _ytDlpPath = "";
    private string _ffmpegPath = "";
    private string _selectedDrive = "";
    private string _subfolder = "";
    private List<DriveInfo> _drives = [];
    private bool _downloadingYtDlp;
    private bool _downloadingFfmpeg;
    private string? _toolMessage;
    private bool _toolError;

    protected override void OnInitialized()
    {
        _clientId = Settings.SpotifyClientId;
        _downloadPath = Settings.DownloadPath;
        _ytDlpPath = Settings.YtDlpPath;
        _ffmpegPath = Settings.FfmpegPath;
        _selectedDrive = Settings.DeviceDriveLetter ?? "";
        _subfolder = Settings.DeviceSubfolder ?? "Music";
        _drives = FileTransferService.GetRemovableDrives();
    }

    private void AutoSave()
    {
        Settings.SpotifyClientId = _clientId.Trim();
        Settings.DownloadPath = _downloadPath.Trim();
        Settings.YtDlpPath = _ytDlpPath.Trim();
        Settings.FfmpegPath = _ffmpegPath.Trim();
        Settings.DeviceDriveLetter = string.IsNullOrWhiteSpace(_selectedDrive) ? null : _selectedDrive;
        Settings.DeviceSubfolder = _subfolder.Trim();
        Settings.Save();
    }

    private async Task DownloadYtDlp()
    {
        _downloadingYtDlp = true;
        _toolMessage = "Downloading yt-dlp...";
        _toolError = false;
        StateHasChanged();

        try
        {
            await ToolDownload.DownloadYtDlpAsync();
            _ytDlpPath = ToolDownload.YtDlpPath;
            _toolMessage = "✓ yt-dlp downloaded successfully!";
            AutoSave();
        }
        catch (Exception ex)
        {
            _toolMessage = $"✗ Failed to download yt-dlp: {ex.Message}";
            _toolError = true;
        }
        finally
        {
            _downloadingYtDlp = false;
        }
    }

    private async Task DownloadFfmpeg()
    {
        _downloadingFfmpeg = true;
        _toolMessage = "Downloading ffmpeg (~90MB, this may take a minute)...";
        _toolError = false;
        StateHasChanged();

        try
        {
            await ToolDownload.DownloadFfmpegAsync();
            _ffmpegPath = ToolDownload.FfmpegPath;
            _toolMessage = "✓ ffmpeg downloaded successfully!";
            AutoSave();
        }
        catch (Exception ex)
        {
            _toolMessage = $"✗ Failed to download ffmpeg: {ex.Message}";
            _toolError = true;
        }
        finally
        {
            _downloadingFfmpeg = false;
        }
    }
}
